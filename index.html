<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TikTok Login Demo (Insecure)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, background: #f5f8fc; }
        .container { max-width: 400px; margin: 80px auto; background: #fff; padding: 32px 22px; border-radius: 10px; box-shadow: 0 2px 18px #eaeaea; }
        h2 { font-weight: 600; }
        button { padding: 12px 32px; background: #16181a; color: #fff; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #222326; }
        .profile { margin-top: 28px; }
        #result { margin-top: 18px; color: #1a8991; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Login with TikTok (DEMO)</h2>
        <button onclick="loginTikTok()">Continue with TikTok</button>
        <div id="result"></div>
        <div id="profile" class="profile"></div>
    </div>
    <script>
        // Fill these in from your Tiktok developer portal/app setup
        const CLIENT_KEY = "sbawjjtuzyd0z5u7fv";
        const CLIENT_SECRET = "Qdq5gHGlMppmWIFVgpxqDo18Wa7XQFhO";
        const REDIRECT_URI = "https://kennethmyrwjy.github.io/callback.html"; // This page's URL must match TikTok registered redirect URI
        const SCOPES = "user.info.basic user.info.profile user.info.stats video.list";
        const AUTHORIZE_URL = "https://www.tiktok.com/v2/auth/authorize/";

        function createState() {
            return Math.random().toString(36).substring(2, 15);
        }

        function loginTikTok() {
            const state = createState();
            localStorage.setItem("tiktokState", state);
            const url = `${AUTHORIZE_URL}?client_key=${encodeURIComponent(CLIENT_KEY)}&scope=${encodeURIComponent(SCOPES)}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&state=${encodeURIComponent(state)}`;
            window.location.href = url;
        }

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        async function main() {
            const code = getQueryParam("code");
            const state = getQueryParam("state");
            if (code && state === localStorage.getItem("tiktokState")) {
                document.getElementById("result").innerText = "Exchanging code for token...";
                // Direct token request (client secret visible; for test/demos only)
                const params = new URLSearchParams({
                    client_key: CLIENT_KEY,
                    client_secret: CLIENT_SECRET,
                    code: code,
                    grant_type: "authorization_code",
                    redirect_uri: REDIRECT_URI
                });
                try {
                    const resp = await fetch("https://open.tiktokapis.com/v2/oauth/token/", {
                        method: "POST",
                        headers: { "Content-Type": "application/x-www-form-urlencoded" },
                        body: params.toString()
                    });
                    const tokenData = await resp.json();
                    if (tokenData.access_token && tokenData.open_id) {
                        document.getElementById("result").innerText = "Token acquired! Loading profile...";
                        showProfile(tokenData.access_token);
                    } else {
                        document.getElementById("result").innerText = "Error getting token: " + JSON.stringify(tokenData);
                    }
                } catch (e) {
                    document.getElementById("result").innerText = "Token exchange failed: " + e;
                }
            }
        }

        async function showProfile(access_token) {
            try {
                const apiUrl = "https://open.tiktokapis.com/v2/user/info/?fields=open_id,display_name,avatar_url";
                const resp = await fetch(apiUrl, {
                    headers: { "Authorization": "Bearer " + access_token }
                });
                const data = await resp.json();
                if (data.data && data.data.display_name) {
                    document.getElementById("profile").innerHTML = `
                        <h4>Welcome, ${data.data.display_name}</h4>
                        <img src="${data.data.avatar_url}" alt="Avatar" style="width:56px;border-radius:28px;">
                        <p>open_id: ${data.data.open_id}</p>
                    `;
                } else {
                    document.getElementById("profile").innerText = "Profile fetch failed: " + JSON.stringify(data);
                }
            } catch (e) {
                document.getElementById("profile").innerText = "Error fetching profile: " + e;
            }
        }

        // Run main() on page load if redirected back with params
        if (getQueryParam("code")) {
            main();
        }
    </script>
</body>
</html>
