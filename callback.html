<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TikTok Login Callback</title>
    <style>
        body { font-family: Arial; background: #f7fafe; }
        .container { max-width: 460px; margin: 70px auto; background: #fff; padding: 32px; border-radius: 10px; box-shadow: 0px 2px 16px #eaeaea; }
        .profile { margin-top: 25px; }
        .avatar { width:60px; border-radius:28px; }
        table { width:100%; border-collapse: collapse; margin-top:18px; }
        td, th { padding: 5px 10px; border-bottom:1px solid #eee; }
        th { background: #eaf7fa;}
        .videos { margin-top: 20px; }
        .video-thumb { width:56px; border-radius:9px; }
    </style>
</head>
<body>
<div class="container">
    <h2>TikTok OAuth Callback</h2>
    <div id="result">Processing TikTok login ...</div>
    <div class="profile" id="profile"></div>
    <div class="videos" id="videos"></div>
</div>
<script>
    // ==== Replace with your credentials for the test ====
    const CLIENT_KEY = 'sbawjjtuzyd0z5u7fv';
    const CLIENT_SECRET = 'Qdq5gHGlMppmWIFVgpxqDo18Wa7XQFhO';
    const REDIRECT_URI = 'https://kennethmyrwjy.github.io/callback.html';

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    async function main() {
        const code = getQueryParam('code');
        if (!code) {
            document.getElementById('result').innerText = 'Error: No OAuth code received from TikTok!';
            return;
        }
        document.getElementById('result').innerText = 'Exchanging code for access token...';

        const params = new URLSearchParams({
            client_key: CLIENT_KEY,
            client_secret: CLIENT_SECRET,
            code: code,
            grant_type: 'authorization_code',
            redirect_uri: REDIRECT_URI
        });

        try {
            const res = await fetch('https://open.tiktokapis.com/v2/oauth/token/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params.toString()
            });
            const data = await res.json();
            if (data.access_token && data.open_id) {
                document.getElementById('result').innerText = 'Token acquired. Loading profile info...';
                fetchProfile(data.access_token);
                fetchVideos(data.access_token, data.open_id); // option to load videos
            } else {
                document.getElementById('result').innerText = 'Failed to get access token: ' + JSON.stringify(data);
            }
        } catch (e) {
            document.getElementById('result').innerText = 'Token exchange failed: ' + e;
        }
    }

    async function fetchProfile(token) {
        // Extended fields for profile, stats, profile info
        const url = 'https://open.tiktokapis.com/v2/user/info/?fields=open_id,display_name,avatar_url,bio_description,follower_count,following_count,likes_count,video_count,is_verified,profile_deep_link,region,gender,signup_time,extra';
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        // Check for errors (including scope authorization issues)
        if (data.error) {
            document.getElementById('profile').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Error fetching profile:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>This may be due to missing scopes. Make sure you selected all required scopes on the login page and that your TikTok app has these scopes approved in the Developer Portal.</em>
                </div>`;
            return;
        }
        
        if (data.data && data.data.user) {
            const u = data.data.user;

            document.getElementById('profile').innerHTML =
                `<img class="avatar" src="${u.avatar_url || ''}" alt="Avatar"><br>
                <table>
                  <tr><th>Display Name</th><td>${u.display_name || 'N/A'}</td></tr>
                  <tr><th>Open ID</th><td>${u.open_id || 'N/A'}</td></tr>
                  <tr><th>Bio</th><td>${u.bio_description || 'N/A'}</td></tr>
                  <tr><th>Region</th><td>${u.region || 'N/A'}</td></tr>
                  <tr><th>Gender</th><td>${u.gender || 'N/A'}</td></tr>
                  <tr><th>Verified</th><td>${u.is_verified ? 'Yes' : 'No'}</td></tr>
                  <tr><th>Followers</th><td>${u.follower_count !== undefined ? u.follower_count : 'N/A'}</td></tr>
                  <tr><th>Following</th><td>${u.following_count !== undefined ? u.following_count : 'N/A'}</td></tr>
                  <tr><th>Likes</th><td>${u.likes_count !== undefined ? u.likes_count : 'N/A'}</td></tr>
                  <tr><th>Video Count</th><td>${u.video_count !== undefined ? u.video_count : 'N/A'}</td></tr>
                  <tr><th>Profile Link</th><td>${u.profile_deep_link ? `<a href="${u.profile_deep_link}" target="_blank">Link</a>` : 'N/A'}</td></tr>
                  <tr><th>Signup Time</th><td>${u.signup_time || 'N/A'}</td></tr>
                </table>`;
        } else {
            document.getElementById('profile').innerText = 'Could not fetch profile data: ' + JSON.stringify(data);
        }
    }

    async function fetchVideos(token, open_id) {
        // Pull videos if scope allows
        const url = `https://open.tiktokapis.com/v2/video/list/?fields=video_id,video_description,cover_image_url,share_url,create_time,duration,tags,statistics&open_id=${open_id}`;
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        // Check for errors (including scope authorization issues)
        if (data.error) {
            document.getElementById('videos').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Error fetching videos:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>Make sure you selected the "video.list" scope and that it's approved in your TikTok Developer Portal.</em>
                </div>`;
            return;
        }
        
        if (data.data && Array.isArray(data.data.videos) && data.data.videos.length > 0) {
            let html = `<h4>User Videos:</h4><ul>`;
            for (const v of data.data.videos) {
                html += `<li>
                  <img class="video-thumb" src="${v.cover_image_url}" alt="Video thumb">
                  <a href="${v.share_url}" target="_blank">${v.video_description || 'No Description'}</a>
                  <br>Duration: ${v.duration}s
                  <br>Views: ${v.statistics && v.statistics.view_count ? v.statistics.view_count : 0}
                  <br>Created: ${v.create_time}
                </li>`;
            }
            html += `</ul>`;
            document.getElementById('videos').innerHTML = html;
        } else if (data.data && Array.isArray(data.data.videos) && data.data.videos.length === 0) {
            document.getElementById('videos').innerText = 'No videos found for this user.';
        } else {
            document.getElementById('videos').innerText = 'Unable to fetch videos. This may be due to missing "video.list" scope or the user has no videos.';
        }
    }

    main();
</script>
</body>
</html>
