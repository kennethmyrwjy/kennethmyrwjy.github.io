<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TikTok Login Callback</title>
    <style>
        body { font-family: Arial; background: #f7fafe; }
        .container { max-width: 460px; margin: 70px auto; background: #fff; padding: 32px; border-radius: 10px; box-shadow: 0px 2px 16px #eaeaea; }
        .profile { margin-top: 25px; }
        .avatar { width:60px; border-radius:28px; }
        table { width:100%; border-collapse: collapse; margin-top:18px; }
        td, th { padding: 5px 10px; border-bottom:1px solid #eee; }
        th { background: #eaf7fa;}
        .videos { margin-top: 20px; }
        .video-thumb { width:56px; border-radius:9px; }
    </style>
</head>
<body>
<div class="container">
    <h2>TikTok OAuth Callback</h2>
    <div id="result">Processing TikTok login ...</div>
    <div class="profile" id="profile"></div>
    <div class="videos" id="videos"></div>
</div>
<script src="config.js"></script>
<script>
    // Configuration loaded from config.js
    const CLIENT_KEY = CONFIG.CLIENT_KEY;
    const REDIRECT_URI = CONFIG.REDIRECT_URI;
    const PROXY_URL = CONFIG.PROXY_URL;
    
    // CLIENT_SECRET is NOT needed in frontend - it's only used in the backend proxy server!

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    async function main() {
        const code = getQueryParam('code');
        if (!code) {
            document.getElementById('result').innerText = 'Error: No OAuth code received from TikTok!';
            return;
        }
        document.getElementById('result').innerText = 'Exchanging code for access token via proxy...';

        console.log('Token exchange request via proxy:', {
            proxyUrl: PROXY_URL,
            code: code.substring(0, 10) + '...' // Log partial code for debugging
        });

        try {
            // Call proxy server instead of TikTok directly
            const res = await fetch(`${PROXY_URL}/token-exchange`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'  // Skip ngrok warning page
                },
                body: JSON.stringify({ code: code })
            });
            
            // Check if response is OK first
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: 'Unknown error' }));
                document.getElementById('result').innerHTML = 
                    `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                        <strong>Proxy Server Error (HTTP ${res.status})</strong><br><br>
                        ${JSON.stringify(errorData, null, 2)}<br><br>
                        <strong>Troubleshooting:</strong><br>
                        ‚Ä¢ Make sure proxy server is running at: <code>${PROXY_URL}</code><br>
                        ‚Ä¢ Check if authorization code is valid (codes expire quickly!)<br>
                        ‚Ä¢ Verify CLIENT_KEY and CLIENT_SECRET in proxy server<br>
                        ‚Ä¢ Check proxy server logs for details<br><br>
                        <em>üí° Run: <code>cd proxy-server && npm install && npm start</code></em>
                    </div>`;
                console.error('Proxy error:', errorData);
                return;
            }
            
            const data = await res.json();
            console.log('Token exchange response:', {
                hasAccessToken: !!data.access_token,
                hasOpenId: !!data.open_id,
                error: data.error
            });

            if (data.access_token && data.open_id) {
                document.getElementById('result').innerText = 'Token acquired! Loading profile info...';
                
                // Get the scopes that were selected during login
                const selectedScopes = localStorage.getItem("tiktokScopes") || "user.info.basic";
                console.log('Fetching data for scopes:', selectedScopes);
                
                // Fetch profile data based on selected scopes
                fetchProfile(data.access_token, selectedScopes);
                
                // If video.list scope was selected, try to fetch videos
                if (selectedScopes.includes('video.list')) {
                    fetchVideos(data.access_token, data.open_id);
                } else {
                    document.getElementById('videos').innerHTML = 
                        `<div style="color: #95a5a6; padding: 15px; background: #ecf0f1; border-radius: 6px; margin-top: 20px;">
                            <strong>üìπ Video List</strong><br><br>
                            Video list scope was not selected. To fetch videos, select the <code>video.list</code> scope on the login page.
                        </div>`;
                }
            } else {
                document.getElementById('result').innerHTML = 
                    `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                        <strong>Token Exchange Failed</strong><br><br>
                        ${JSON.stringify(data, null, 2)}<br><br>
                        <em>Check the proxy server logs for more details.</em>
                    </div>`;
            }
        } catch (e) {
            document.getElementById('result').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Connection Error:</strong><br>
                    ${e.message}<br><br>
                    <strong>Is your proxy server running?</strong><br>
                    ‚Ä¢ Local: Make sure it's running at <code>${PROXY_URL}</code><br>
                    ‚Ä¢ Deployed: Update PROXY_URL to your deployed server URL<br><br>
                    <strong>To start locally:</strong><br>
                    <code>cd proxy-server && npm install && npm start</code><br><br>
                    Check browser console for more details.
                </div>`;
            console.error('Token exchange exception:', e);
        }
    }

    async function fetchProfile(token, selectedScopes) {
        // Build fields to request based on selected scopes
        let fields = [];
        
        // user.info.basic - Basic profile info
        if (selectedScopes.includes('user.info.basic')) {
            fields.push('open_id', 'union_id', 'avatar_url', 'display_name');
        }
        
        // user.info.profile - Extended profile info
        if (selectedScopes.includes('user.info.profile')) {
            fields.push('bio_description', 'region', 'gender', 'signup_time', 'profile_deep_link');
        }
        
        // user.info.stats - User statistics
        if (selectedScopes.includes('user.info.stats')) {
            fields.push('follower_count', 'following_count', 'likes_count', 'video_count');
        }
        
        // Remove duplicates and build query
        fields = [...new Set(fields)];
        const fieldsParam = fields.join(',');
        
        console.log('Requesting fields:', fieldsParam);
        
        const url = `https://open.tiktokapis.com/v2/user/info/?fields=${fieldsParam}`;
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        console.log('TikTok user/info response:', data);
        
        // Check for actual errors (code is NOT "ok")
        // TikTok returns error.code="ok" for successful requests (even with empty data)
        if (data.error && data.error.code && data.error.code !== "ok") {
            document.getElementById('profile').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Error fetching profile:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>Error code: ${data.error.code}</em><br>
                    <em>This may be due to missing scopes or API permissions. Check your TikTok Developer Portal settings.</em>
                </div>`;
            return;
        }
        
        // Check for successful response with code="ok" but no data (sandbox mode)
        // TikTok can return just {code: "ok", message: "", log_id: "..."} in sandbox
        if ((data.code === "ok" || (data.error && data.error.code === "ok")) && (!data.data || !data.data.user)) {
            document.getElementById('profile').innerHTML = 
                `<div style="color: #f39c12; padding: 20px; background: #fef5e7; border-radius: 6px; border-left: 4px solid #f39c12;">
                    <h3 style="margin-top: 0;">üéâ OAuth Flow Successful!</h3>
                    <p style="margin-bottom: 10px;"><strong>‚úÖ Your implementation is working correctly!</strong></p>
                    <p style="margin-bottom: 10px; font-size: 13px;">TikTok API returned: <code style="font-size: 11px;">${JSON.stringify(data)}</code></p>
                    <hr style="border: none; border-top: 1px solid #f39c12; margin: 15px 0;">
                    <h4>‚ö†Ô∏è Sandbox Mode - Limited Data</h4>
                    <p>Your app is in <strong>TikTok Sandbox Mode</strong>. This means:</p>
                    <ul style="margin-left: 20px; font-size: 14px;">
                        <li>‚úÖ OAuth and token exchange work perfectly</li>
                        <li>‚úÖ API calls return <code>code: "ok"</code></li>
                        <li>‚ö†Ô∏è But user data may be empty or mock data</li>
                        <li>‚ùå Extended scopes (stats, videos) unavailable</li>
                    </ul>
                    <h4>üí° What You Can Do Now:</h4>
                    <ol style="margin-left: 20px; font-size: 14px;">
                        <li><strong>Test with <code>user.info.basic</code> only</strong> - This scope has the best chance of returning some data in sandbox</li>
                        <li><strong>Verify your implementation works</strong> - Check that tokens are being exchanged successfully</li>
                        <li><strong>Build your app UI</strong> - Design how you'll display real data once approved</li>
                    </ol>
                    <h4>üìù When Ready for Real Data:</h4>
                    <p style="margin-left: 20px; font-size: 14px;">
                        Go to <a href="https://developers.tiktok.com/apps" target="_blank">TikTok Developer Portal</a> ‚Üí 
                        Submit app for production review ‚Üí Get real user data
                    </p>
                    <p style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 4px; font-size: 13px;">
                        <strong>Your code is production-ready!</strong> The OAuth flow, token exchange, and API integration are all working. 
                        You just need production approval from TikTok to receive real data.
                    </p>
                </div>`;
            return;
        }
        
        if (data.data && data.data.user) {
            const u = data.data.user;
            
            // Build HTML based on available data
            let html = `<div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                ${u.avatar_url ? `<img class="avatar" src="${u.avatar_url}" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px;">` : '<div style="width: 100px; height: 100px; background: #ddd; border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">No Avatar</div>'}
                <h3 style="margin: 10px 0; color: #2c3e50;">${u.display_name || 'Unknown User'}</h3>
            </div>`;
            
            // Basic Info Section (if user.info.basic scope)
            if (selectedScopes.includes('user.info.basic')) {
                html += `<div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 6px; border-left: 4px solid #27ae60;">
                    <h4 style="margin-top: 0; color: #27ae60;">‚úÖ Basic Info (user.info.basic)</h4>
                    <table style="width: 100%;">
                      <tr><th style="text-align: left; padding: 8px;">Display Name</th><td style="padding: 8px;">${u.display_name || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Open ID</th><td style="padding: 8px; font-family: monospace; font-size: 12px;">${u.open_id || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Union ID</th><td style="padding: 8px; font-family: monospace; font-size: 12px;">${u.union_id || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Avatar URL</th><td style="padding: 8px;">${u.avatar_url ? '<span style="color: #27ae60;">‚úì Available</span>' : 'N/A'}</td></tr>
                    </table>
                </div>`;
            }
            
            // Profile Info Section (if user.info.profile scope)
            if (selectedScopes.includes('user.info.profile')) {
                html += `<div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 6px; border-left: 4px solid #2196f3;">
                    <h4 style="margin-top: 0; color: #2196f3;">üìù Profile Info (user.info.profile)</h4>
                    <table style="width: 100%;">
                      <tr><th style="text-align: left; padding: 8px;">Bio</th><td style="padding: 8px;">${u.bio_description || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Region</th><td style="padding: 8px;">${u.region || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Gender</th><td style="padding: 8px;">${u.gender || 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Signup Time</th><td style="padding: 8px;">${u.signup_time ? new Date(u.signup_time * 1000).toLocaleString() : 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Profile Link</th><td style="padding: 8px;">${u.profile_deep_link ? `<a href="${u.profile_deep_link}" target="_blank">Open Profile</a>` : 'N/A'}</td></tr>
                    </table>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                        ‚ö†Ô∏è Limited in sandbox mode - may show "N/A" until production approval
                    </p>
                </div>`;
            }
            
            // Stats Section (if user.info.stats scope)
            if (selectedScopes.includes('user.info.stats')) {
                html += `<div style="margin-top: 20px; padding: 15px; background: #fff3e0; border-radius: 6px; border-left: 4px solid #ff9800;">
                    <h4 style="margin-top: 0; color: #ff9800;">üìä Statistics (user.info.stats)</h4>
                    <table style="width: 100%;">
                      <tr><th style="text-align: left; padding: 8px;">Followers</th><td style="padding: 8px;">${u.follower_count !== undefined ? u.follower_count.toLocaleString() : 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Following</th><td style="padding: 8px;">${u.following_count !== undefined ? u.following_count.toLocaleString() : 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Likes</th><td style="padding: 8px;">${u.likes_count !== undefined ? u.likes_count.toLocaleString() : 'N/A'}</td></tr>
                      <tr><th style="text-align: left; padding: 8px;">Videos</th><td style="padding: 8px;">${u.video_count !== undefined ? u.video_count.toLocaleString() : 'N/A'}</td></tr>
                    </table>
                    <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                        ‚ö†Ô∏è Not available in sandbox mode - requires production approval
                    </p>
                </div>`;
            }
            
            // General note
            html += `<div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px; font-size: 13px; color: #666;">
                <strong>‚ÑπÔ∏è Note:</strong> Data availability depends on:
                <ul style="margin: 10px 0 0 20px; line-height: 1.6;">
                    <li>Selected scopes during login</li>
                    <li>Approved scopes in TikTok Developer Portal</li>
                    <li>App status (Sandbox vs Production)</li>
                </ul>
                <p style="margin: 10px 0 0 0;">
                    Most extended data (profile, stats) requires production approval from TikTok.
                </p>
            </div>`;
            
            document.getElementById('profile').innerHTML = html;
        } else {
            document.getElementById('profile').innerText = 'Could not fetch profile data: ' + JSON.stringify(data);
        }
    }

    async function fetchVideos(token, open_id) {
        document.getElementById('videos').innerHTML = 
            `<div style="padding: 15px; background: #f0f0f0; border-radius: 6px; margin-top: 20px;">
                <strong>üìπ Loading videos...</strong>
            </div>`;
            
        // Pull videos if scope allows
        const url = `https://open.tiktokapis.com/v2/video/list/?fields=video_id,video_description,cover_image_url,share_url,create_time,duration,tags,statistics`;
        const res = await fetch(url, {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + token,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                max_count: 20
            })
        });
        const data = await res.json();
        
        console.log('TikTok video/list response:', data);
        
        // Check for actual errors (code is NOT "ok")
        if (data.error && data.error.code && data.error.code !== "ok") {
            document.getElementById('videos').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px; margin-top: 20px;">
                    <strong>Error fetching videos:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>Error code: ${data.error.code}</em><br>
                    <em>Make sure the "video.list" scope is approved in your TikTok Developer Portal.</em>
                </div>`;
            return;
        }
        
        // Check for sandbox mode (successful but empty response)
        if ((data.code === "ok" || (data.error && data.error.code === "ok")) && (!data.data || !data.data.videos || data.data.videos.length === 0)) {
            document.getElementById('videos').innerHTML = 
                `<div style="color: #f39c12; padding: 15px; background: #fef5e7; border-radius: 6px; margin-top: 20px;">
                    <h4 style="margin-top: 0;">‚ö†Ô∏è Video List (video.list scope)</h4>
                    <p><strong>Sandbox Mode:</strong> The video.list endpoint returns no data in sandbox mode.</p>
                    <p style="margin-bottom: 10px; font-size: 13px;">TikTok API returned: <code style="font-size: 11px;">${JSON.stringify(data)}</code></p>
                    <p style="margin: 10px 0;">To access video data, submit your app for production review in the TikTok Developer Portal.</p>
                </div>`;
            return;
        }
        
        if (data.data && Array.isArray(data.data.videos) && data.data.videos.length > 0) {
            let html = `<h4>User Videos:</h4><ul>`;
            for (const v of data.data.videos) {
                html += `<li>
                  <img class="video-thumb" src="${v.cover_image_url}" alt="Video thumb">
                  <a href="${v.share_url}" target="_blank">${v.video_description || 'No Description'}</a>
                  <br>Duration: ${v.duration}s
                  <br>Views: ${v.statistics && v.statistics.view_count ? v.statistics.view_count : 0}
                  <br>Created: ${v.create_time}
                </li>`;
            }
            html += `</ul>`;
            document.getElementById('videos').innerHTML = html;
        } else if (data.data && Array.isArray(data.data.videos) && data.data.videos.length === 0) {
            document.getElementById('videos').innerText = 'No videos found for this user.';
        } else {
            document.getElementById('videos').innerText = 'Unable to fetch videos. This may be due to missing "video.list" scope or the user has no videos.';
        }
    }

    main();
</script>
</body>
</html>
