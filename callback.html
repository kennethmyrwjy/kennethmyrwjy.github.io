<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TikTok Login Callback</title>
    <style>
        body { font-family: Arial; background: #f7fafe; }
        .container { max-width: 460px; margin: 70px auto; background: #fff; padding: 32px; border-radius: 10px; box-shadow: 0px 2px 16px #eaeaea; }
        .profile { margin-top: 25px; }
        .avatar { width:60px; border-radius:28px; }
        table { width:100%; border-collapse: collapse; margin-top:18px; }
        td, th { padding: 5px 10px; border-bottom:1px solid #eee; }
        th { background: #eaf7fa;}
        .videos { margin-top: 20px; }
        .video-thumb { width:56px; border-radius:9px; }
    </style>
</head>
<body>
<div class="container">
    <h2>TikTok OAuth Callback</h2>
    <div id="result">Processing TikTok login ...</div>
    <div class="profile" id="profile"></div>
    <div class="videos" id="videos"></div>
</div>
<script>
    // ==== Replace with your credentials for the test ====
    const CLIENT_KEY = 'sbawjjtuzyd0z5u7fv';
    const CLIENT_SECRET = 'Qdq5gHGlMppmWIFVgpxqDo18Wa7XQFhO';
    const REDIRECT_URI = 'https://kennethmyrwjy.github.io/callback.html';
    
    // ==== PROXY SERVER CONFIGURATION ====
    // Change this to your deployed proxy URL (e.g., https://your-app.onrender.com)
    // For local testing: 'http://localhost:3000'
    const PROXY_URL = 'https://faceless-deafeningly-geralyn.ngrok-free.dev'; // ngrok tunnel to localhost:3000

    function getQueryParam(name) {
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
    }

    async function main() {
        const code = getQueryParam('code');
        if (!code) {
            document.getElementById('result').innerText = 'Error: No OAuth code received from TikTok!';
            return;
        }
        document.getElementById('result').innerText = 'Exchanging code for access token via proxy...';

        console.log('Token exchange request via proxy:', {
            proxyUrl: PROXY_URL,
            code: code.substring(0, 10) + '...' // Log partial code for debugging
        });

        try {
            // Call proxy server instead of TikTok directly
            const res = await fetch(`${PROXY_URL}/token-exchange`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'  // Skip ngrok warning page
                },
                body: JSON.stringify({ code: code })
            });
            
            // Check if response is OK first
            if (!res.ok) {
                const errorData = await res.json().catch(() => ({ error: 'Unknown error' }));
                document.getElementById('result').innerHTML = 
                    `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                        <strong>Proxy Server Error (HTTP ${res.status})</strong><br><br>
                        ${JSON.stringify(errorData, null, 2)}<br><br>
                        <strong>Troubleshooting:</strong><br>
                        â€¢ Make sure proxy server is running at: <code>${PROXY_URL}</code><br>
                        â€¢ Check if authorization code is valid (codes expire quickly!)<br>
                        â€¢ Verify CLIENT_KEY and CLIENT_SECRET in proxy server<br>
                        â€¢ Check proxy server logs for details<br><br>
                        <em>ðŸ’¡ Run: <code>cd proxy-server && npm install && npm start</code></em>
                    </div>`;
                console.error('Proxy error:', errorData);
                return;
            }
            
            const data = await res.json();
            console.log('Token exchange response:', {
                hasAccessToken: !!data.access_token,
                hasOpenId: !!data.open_id,
                error: data.error
            });

            if (data.access_token && data.open_id) {
                document.getElementById('result').innerText = 'Token acquired! Loading profile info...';
                fetchProfile(data.access_token);
                fetchVideos(data.access_token, data.open_id);
            } else {
                document.getElementById('result').innerHTML = 
                    `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                        <strong>Token Exchange Failed</strong><br><br>
                        ${JSON.stringify(data, null, 2)}<br><br>
                        <em>Check the proxy server logs for more details.</em>
                    </div>`;
            }
        } catch (e) {
            document.getElementById('result').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Connection Error:</strong><br>
                    ${e.message}<br><br>
                    <strong>Is your proxy server running?</strong><br>
                    â€¢ Local: Make sure it's running at <code>${PROXY_URL}</code><br>
                    â€¢ Deployed: Update PROXY_URL to your deployed server URL<br><br>
                    <strong>To start locally:</strong><br>
                    <code>cd proxy-server && npm install && npm start</code><br><br>
                    Check browser console for more details.
                </div>`;
            console.error('Token exchange exception:', e);
        }
    }

    async function fetchProfile(token) {
        // Extended fields for profile, stats, profile info
        const url = 'https://open.tiktokapis.com/v2/user/info/?fields=open_id,display_name,avatar_url,bio_description,follower_count,following_count,likes_count,video_count,is_verified,profile_deep_link,region,gender,signup_time,extra';
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        // Check for errors (including scope authorization issues)
        if (data.error) {
            document.getElementById('profile').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Error fetching profile:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>This may be due to missing scopes. Make sure you selected all required scopes on the login page and that your TikTok app has these scopes approved in the Developer Portal.</em>
                </div>`;
            return;
        }
        
        if (data.data && data.data.user) {
            const u = data.data.user;

            document.getElementById('profile').innerHTML =
                `<img class="avatar" src="${u.avatar_url || ''}" alt="Avatar"><br>
                <table>
                  <tr><th>Display Name</th><td>${u.display_name || 'N/A'}</td></tr>
                  <tr><th>Open ID</th><td>${u.open_id || 'N/A'}</td></tr>
                  <tr><th>Bio</th><td>${u.bio_description || 'N/A'}</td></tr>
                  <tr><th>Region</th><td>${u.region || 'N/A'}</td></tr>
                  <tr><th>Gender</th><td>${u.gender || 'N/A'}</td></tr>
                  <tr><th>Verified</th><td>${u.is_verified ? 'Yes' : 'No'}</td></tr>
                  <tr><th>Followers</th><td>${u.follower_count !== undefined ? u.follower_count : 'N/A'}</td></tr>
                  <tr><th>Following</th><td>${u.following_count !== undefined ? u.following_count : 'N/A'}</td></tr>
                  <tr><th>Likes</th><td>${u.likes_count !== undefined ? u.likes_count : 'N/A'}</td></tr>
                  <tr><th>Video Count</th><td>${u.video_count !== undefined ? u.video_count : 'N/A'}</td></tr>
                  <tr><th>Profile Link</th><td>${u.profile_deep_link ? `<a href="${u.profile_deep_link}" target="_blank">Link</a>` : 'N/A'}</td></tr>
                  <tr><th>Signup Time</th><td>${u.signup_time || 'N/A'}</td></tr>
                </table>`;
        } else {
            document.getElementById('profile').innerText = 'Could not fetch profile data: ' + JSON.stringify(data);
        }
    }

    async function fetchVideos(token, open_id) {
        // Pull videos if scope allows
        const url = `https://open.tiktokapis.com/v2/video/list/?fields=video_id,video_description,cover_image_url,share_url,create_time,duration,tags,statistics&open_id=${open_id}`;
        const res = await fetch(url, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        
        // Check for errors (including scope authorization issues)
        if (data.error) {
            document.getElementById('videos').innerHTML = 
                `<div style="color: #e74c3c; padding: 15px; background: #fadbd8; border-radius: 6px;">
                    <strong>Error fetching videos:</strong><br>
                    ${data.error.message || JSON.stringify(data.error)}<br><br>
                    <em>Make sure you selected the "video.list" scope and that it's approved in your TikTok Developer Portal.</em>
                </div>`;
            return;
        }
        
        if (data.data && Array.isArray(data.data.videos) && data.data.videos.length > 0) {
            let html = `<h4>User Videos:</h4><ul>`;
            for (const v of data.data.videos) {
                html += `<li>
                  <img class="video-thumb" src="${v.cover_image_url}" alt="Video thumb">
                  <a href="${v.share_url}" target="_blank">${v.video_description || 'No Description'}</a>
                  <br>Duration: ${v.duration}s
                  <br>Views: ${v.statistics && v.statistics.view_count ? v.statistics.view_count : 0}
                  <br>Created: ${v.create_time}
                </li>`;
            }
            html += `</ul>`;
            document.getElementById('videos').innerHTML = html;
        } else if (data.data && Array.isArray(data.data.videos) && data.data.videos.length === 0) {
            document.getElementById('videos').innerText = 'No videos found for this user.';
        } else {
            document.getElementById('videos').innerText = 'Unable to fetch videos. This may be due to missing "video.list" scope or the user has no videos.';
        }
    }

    main();
</script>
</body>
</html>
